# YouTube Analytics Dashboard

> YouTube 트렌딩 데이터를 수집하고 AI 기반 분석을 제공하는 데이터 파이프라인

---

## 아키텍처

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                          YouTube Analytics Pipeline                              │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│   ┌─────────────┐     ┌─────────────┐     ┌─────────────┐     ┌─────────────┐   │
│   │   GitHub    │────▶│ Cloud Build │────▶│   GCR       │────▶│  Cloud Run  │   │
│   │   (Push)    │     │  (트리거)    │     │  (이미지)   │     │    Job      │   │
│   └─────────────┘     └─────────────┘     └─────────────┘     └──────┬──────┘   │
│                                                                      │          │
│   ┌──────────────────────────────────────────────────────────────────┘          │
│   │                                                                              │
│   │   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │   │                    Cloud Scheduler (스케줄러)                        │   │
│   │   ├─────────────┬─────────────┬─────────────┬─────────────┐             │   │
│   │   │  videos     │  comments   │ categories  │  channels   │             │   │
│   │   │  (매시간)    │  (매시간)    │  (주1회)     │  (일1회)     │             │   │
│   │   │  0 * * * *  │  5 * * * *  │  0 0 * * 0  │  0 1 * * *  │             │   │
│   │   └──────┬──────┴──────┬──────┴──────┬──────┴──────┬──────┘             │   │
│   │          │             │             │             │                     │   │
│   │          ▼             ▼             ▼             ▼                     │   │
│   │   ┌─────────────────────────────────────────────────────────────────┐   │   │
│   │   │                     YouTube Data API v3                          │   │   │
│   │   │  videos.list │ commentThreads.list │ videoCategories │ channels  │   │   │
│   │   └─────────────────────────────────────────────────────────────────┘   │   │
│   │                                    │                                     │   │
│   └────────────────────────────────────┼─────────────────────────────────────┘   │
│                                        ▼                                         │
│   ┌─────────────────────────────────────────────────────────────────────────┐   │
│   │                         GCS Bucket (Raw 레이어)                          │   │
│   │                                                                          │   │
│   │   gs://plosind-youtube-raw-data/                                        │   │
│   │   └── raw/youtube/                                                       │   │
│   │       ├── videos_list/region=KR/date=YYYY-MM-DD/hour=HH/                │   │
│   │       ├── comment_threads/region=KR/date=YYYY-MM-DD/hour=HH/video_id=/  │   │
│   │       ├── video_categories/region=KR/date=YYYY-MM-DD/                   │   │
│   │       └── channels/date=YYYY-MM-DD/                                     │   │
│   │                                                                          │   │
│   └─────────────────────────────────────────────────────────────────────────┘   │
│                                        │                                         │
│                                        ▼                                         │
│   ┌─────────────────────────────────────────────────────────────────────────┐   │
│   │                      Transform 레이어 (Python/DBT)                       │   │
│   │                                                                          │   │
│   │   Raw JSON ──▶ Clean 테이블 ──▶ Mart 뷰                                 │   │
│   │                                                                          │   │
│   └─────────────────────────────────────────────────────────────────────────┘   │
│                                        │                                         │
│                                        ▼                                         │
│   ┌─────────────────────────────────────────────────────────────────────────┐   │
│   │                         Supabase (PostgreSQL)                            │   │
│   │                                                                          │   │
│   │   ┌─────────────┐    ┌─────────────┐    ┌─────────────┐                 │   │
│   │   │   Clean     │    │    Mart     │    │    Role     │                 │   │
│   │   │   테이블     │───▶│     뷰      │───▶│  (AI 전용)   │                 │   │
│   │   └─────────────┘    └─────────────┘    └──────┬──────┘                 │   │
│   │                                                │                         │   │
│   └────────────────────────────────────────────────┼─────────────────────────┘   │
│                                                    │                             │
│                                                    ▼                             │
│   ┌─────────────────────────────────────────────────────────────────────────┐   │
│   │                          애플리케이션 레이어                              │   │
│   │                                                                          │   │
│   │   ┌─────────────┐         ┌─────────────┐         ┌─────────────┐       │   │
│   │   │   Ollama    │◀───────▶│  Streamlit  │◀───────▶│   사용자     │       │   │
│   │   │  (LLM AI)   │         │ (대시보드)   │         │  (브라우저)  │       │   │
│   │   └─────────────┘         └─────────────┘         └─────────────┘       │   │
│   │                                                                          │   │
│   └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                  │
└──────────────────────────────────────────────────────────────────────────────────┘
```

---

## 기술 스택

| 레이어 | 기술 | 설명 |
|--------|------|------|
| **스케줄링** | Cloud Scheduler | Cron 기반 작업 스케줄링 |
| **컴퓨팅** | Cloud Run Job | 서버리스 컨테이너 실행 |
| **스토리지** | Google Cloud Storage | Raw 데이터 저장소 |
| **데이터베이스** | Supabase (PostgreSQL) | Clean/Mart 테이블 저장 |
| **변환** | Python / DBT | 데이터 정제 및 집계 |
| **AI** | Ollama | 로컬 LLM 기반 분석 |
| **대시보드** | Streamlit | 시각화 및 사용자 인터페이스 |
| **CI/CD** | Cloud Build + GitHub | 자동 빌드 및 배포 |

---

## 프로젝트 구조

```
DE_pro/
├── youtube_collector/          # 데이터 수집기
│   ├── src/
│   │   ├── clients/           # API 클라이언트
│   │   │   └── youtube.py     # YouTube API 호출
│   │   ├── collectors/        # 수집기 클래스
│   │   │   ├── base.py        # 베이스 클래스
│   │   │   ├── videos.py      # 트렌딩 영상 수집
│   │   │   ├── comments.py    # 댓글 수집
│   │   │   ├── categories.py  # 카테고리 수집
│   │   │   └── channels.py    # 채널 정보 수집
│   │   ├── storage/           # 스토리지 클래스
│   │   │   └── gcs.py         # GCS 업로드
│   │   ├── config.py          # 환경변수 설정
│   │   └── main.py            # CLI 진입점
│   ├── Dockerfile
│   ├── requirements.txt
│   └── cloudbuild.yaml
├── .env                        # 환경변수 (Git 제외)
└── README.md
```

---

## 데이터 흐름

```
┌──────────────────────────────────────────────────────────────────────────┐
│                            데이터 수집 작업                               │
├──────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│   Job 1: videos        Job 2: comments      Job 3: categories            │
│   ┌──────────────┐     ┌──────────────┐     ┌──────────────┐            │
│   │ 트렌딩 50개   │     │ 상위 5개 영상 │     │ 카테고리 매핑 │            │
│   │ 영상/시간당   │     │ 댓글 100개   │     │ 주간 동기화   │            │
│   └──────┬───────┘     └──────┬───────┘     └──────┬───────┘            │
│          │                    │                    │                     │
│          ▼                    ▼                    ▼                     │
│   ┌─────────────────────────────────────────────────────────────────┐   │
│   │                    GCS: Raw 레이어 (JSON.gz)                     │   │
│   │                                                                  │   │
│   │  • Hive 스타일 파티셔닝 (region/date/hour)                       │   │
│   │  • 불변, 추가 전용 (append-only)                                 │   │
│   │  • 메타데이터 포함 (_metadata.json)                              │   │
│   └─────────────────────────────────────────────────────────────────┘   │
│                                                                          │
└──────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌──────────────────────────────────────────────────────────────────────────┐
│                               변환 단계                                   │
├──────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│   Raw (GCS)              Clean (Supabase)         Mart (Supabase)       │
│   ┌──────────┐          ┌──────────────┐        ┌──────────────┐        │
│   │ JSON.gz  │ ──────▶  │ videos       │ ─────▶ │ trending_    │        │
│   │ 파일     │          │ comments     │        │ analysis     │        │
│   │          │          │ categories   │        │ channel_stats│        │
│   └──────────┘          └──────────────┘        └──────────────┘        │
│                                                                          │
│   • 역정규화              • 중복 제거             • 집계 데이터           │
│   • 스키마 검증           • 타입 변환             • 메트릭 계산           │
│                          • PK 제약조건           • AI용 뷰               │
│                                                                          │
└──────────────────────────────────────────────────────────────────────────┘
```

---

## Raw 데이터 보관 정책

| 데이터 유형 | 보관 기간 | 이유 |
|-------------|-----------|------|
| `videos_list` | 90일 | 트렌드 추세/계절성 분석용 |
| `comment_threads` | 14일 | 용량이 큼, Clean에서 요약만 저장 |
| `video_categories` | 365일 | 거의 변경 없음, 보관 부담 없음 |
| `channels` | 180일 | 채널 성장 분석용 |

---

## 사용법

### 로컬 개발

```bash
# 환경변수 설정
cp .env.example .env

# 의존성 설치
cd youtube_collector
pip install -r requirements.txt

# 수집 실행
python -m src.main --job=videos      # 트렌딩 영상
python -m src.main --job=comments    # 댓글
python -m src.main --job=categories  # 카테고리
python -m src.main --job=channels    # 채널 정보
```

### Docker

```bash
# 이미지 빌드
docker build -t youtube-collector ./youtube_collector

# 컨테이너 실행
docker run --env-file .env youtube-collector --job=videos
```

### Cloud Run Job 배포

```bash
# Job 생성
gcloud run jobs create youtube-videos \
  --image gcr.io/deproject-482905/youtube-collector \
  --args="--job=videos" \
  --region=asia-northeast3

# 스케줄러 연결
gcloud scheduler jobs create http youtube-videos-scheduler \
  --schedule="0 * * * *" \
  --uri="https://asia-northeast3-run.googleapis.com/..." \
  --http-method=POST
```

---

## 환경변수

```env
# YouTube API
YOUTUBE_API_KEY=your_api_key

# GCP 설정
GCP_PROJECT_ID=deproject-482905
GCS_BUCKET_NAME=plosind-youtube-raw-data

# 수집 설정
YOUTUBE_REGION_CODE=KR                          # 수집 대상 지역
YOUTUBE_MAX_RESULTS=50                          # 트렌딩 영상 수
YOUTUBE_COMMENT_TARGET_VIDEOS_PER_SNAPSHOT=5    # 댓글 수집 대상 영상 수
YOUTUBE_COMMENT_MAX_PAGES_PER_VIDEO=2           # 영상당 댓글 페이지 수
```

---

## 라이선스

MIT
